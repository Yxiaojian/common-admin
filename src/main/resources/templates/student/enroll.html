<!DOCTYPE html>
<html xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="utf-8">
    <title>新生报名页面</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="/static/layui/css/layui.css" media="all"/>
    <link rel="stylesheet" href="/static/css/public.css" media="all"/>
    <style>
        .needspan label.error{
            float: left;
            margin-left: 108px;
        }
    </style>
</head>
<body class="childrenBody">
<form class="layui-form studentform" id="studentForm">
    <div class="layui-tab layui-tab-brief" lay-filter="enrollForm">
        <div class="enrtitle">新生报名</div>
        <ul class="layui-tab-title">
            <i class="sticons icons-jcxx" style="margin-left: 20px;"></i>
            <li class="layui-this" lay-id="basicInfo" style="pointer-events: none;">基本信息</li>
            <i class="sticons icons-bj" style="margin-left: 20px;"></i>
            <li lay-id="classInfo" style="pointer-events: none;">班级信息</li>
            <i class="sticons icons-jf" style="margin-left: 20px;"></i>
            <li lay-id="feeInfo" style="pointer-events: none;">客户缴费</li>
        </ul>
        <div class="layui-tab-content" style="height: 100px;">
            <div class="layui-tab-item layui-show">
                <div class="layui-col-md8 layui-col-xs12" style="margin: 35px;">

                    <div class="layui-form-item posirea">
                        <label class="layui-form-label">姓名</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" required id="userName" maxlength="256"
                                   name="userName" placeholder="请输入姓名">
                        </div>
                        <span class="reqInfo" style="left: 50px;">*</span>
                    </div>
                    <div class="layui-form-item posirea">
                        <label class="layui-form-label">电话1</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" required id="mobilePhone1" maxlength="32"
                                   name="mobilePhone1" placeholder="电话号码">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="phone1Info" maxlength="256" name="phone1Info"
                                   placeholder="备注">
                        </div>
                        <span class="reqInfo" style="left: 45px;">*</span>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">性别</label>
                        <div class="layui-input-block">
                            <select class="state" name="sex">
                                <option value="1">男</option>
                                <option value="0">女</option>
                            </select>
                        </div>
                    </div>


                    <div class="layui-form-item">
                        <label class="layui-form-label">电话2</label>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="mobilePhone2" maxlength="32" name="mobilePhone2"
                                   placeholder="电话号码">
                        </div>
                        <div class="layui-input-inline">
                            <input type="text" class="layui-input" id="phone2Info" maxlength="256" name="phone2Info"
                                   placeholder="备注">
                        </div>
                    </div>

                    <div class="layui-form-item posirea">
                        <label class="layui-form-label">学校</label>
                        <div class="layui-input-block">
                            <input type="text" class="layui-input" required id="school" maxlength="256" name="school"
                                   placeholder="请输入学校">
                        </div>
                        <span class="reqInfo" style="left: 50px;">*</span>
                    </div>

                    <div class="layui-form-item posirea">
                        <div class="layui-inline posirea" style="margin-right: 0;">
                            <label class="layui-form-label">年级</label>
                            <div class="layui-input-inline">
                                <select class="state" id="js_gradeSel"  lay-filter="js_gradeSel" name="grade">
                                    <option value="1">一年级</option>
                                    <option value="2">二年级</option>
                                    <option value="3">三年级</option>
                                    <option value="4">四年级</option>
                                    <option value="5">五年级</option>
                                    <option value="6">六年级</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 60px;">入学年份</label>
                            <div class="layui-input-inline" style="width: 110px;">
                                <input type="text" class="layui-input"  lay-filter="startYear" id="startYear" name="startYear"
                                       placeholder="">
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label">家庭小区</label>
                            <div class="layui-input-block">
                                <input type="text" class="layui-input" id="homeAddress" maxlength="256"
                                       name="homeAddress" placeholder="请输入家庭小区">
                            </div>
                        </div>

                        <div class="layui-form-item">
                            <label class="layui-form-label">生日</label>
                            <div class="layui-input-block">
                                <input type="text" class="layui-input" id="birthday" name="birthday" placeholder="生日">
                            </div>
                        </div>
                        <div class="layui-form-item">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <textarea placeholder="请输入备注" id="remarks" name="remarks" class="layui-textarea"
                                          maxlength="256"></textarea>
                            </div>

                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <a href="javascript:;" class="layui-btn  layui-layout-right js_nextToClass"
                               style="width:100%;">选择班级</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="layui-col-md8 layui-col-xs12" style="margin: 35px ;min-width: 800px;">

                    <div class="layui-form-item">
                        <label class="layui-form-label">选择班级</label>
                        <div class="layui-input-block">
                            <select class="classes" id="classesSselectId" lay-filter="classesSselectId" name="stuClass" lay-verify="required" lay-search="">
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 95px;">类型：</label>
                            <div class="layui-input-inline" style="width: 80px;margin-right: 0;">
                                <label class="layui-form-label" id="classType" style="text-align: left;"></label>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 95px;">年级：</label>
                            <div class="layui-input-inline" style="width: 80px;margin-right: 0;">
                                <label class="layui-form-label" id="grade" style="text-align: left;"></label>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 95px;">班型：</label>
                            <div class="layui-input-inline" style="width: 80px;margin-right: 0;">
                                <label class="layui-form-label" id="gradeType" style="text-align: left;"></label>
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 95px;">人数：</label>
                            <div class="layui-input-inline" style="width: 80px;margin-right: 0;">
                                <label class="layui-form-label" id="stuCount" style="text-align: left;"></label>
                            </div>
                        </div>

                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 95px;">金额：</label>
                            <div class="layui-input-inline" style="width: 110px;">
                                <label class="layui-form-label" id="kcfee" style="text-align: left;"></label>
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 35px;">优惠</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input number" required id="preferential" name="preferential"
                                       value="0" placeholder="">
                            </div>
                        </div>

                        <div class="layui-inline">
                            <label class="layui-form-label" style="padding-left: 0;width: 35px;">预缴</label>
                            <div class="layui-input-inline">
                                <input type="text" class="layui-input number" required id="prePay" name="prePay" value="0"
                                       placeholder="">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline" style="margin-left: 460px;">
                            <label class="layui-form-label" style="padding-left: 0;width: 95px;">欠费：</label>
                            <div class="layui-input-inline" style="width: 80px;margin-right: 0;">
                                <label class="layui-form-label" id="noPay" style="text-align: left;"></label>
                            </div>
                        </div>

                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">说明</label>
                        <div class="layui-input-block">
                            <textarea placeholder="请输入说明" id="classCusInfo" name="discountRemark" class="layui-textarea"
                                      required maxlength="256" placeholder="请输入说明"></textarea>
                            <span class="reqInfo" style="left: -60px;">*</span>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <div class="layui-input-block">
                            <a href="javascript:;" class="layui-btn layui-bg-gray layui-layout-left js_preToClass"
                               style="width:48%;left:0;">上一步</a>
                            <a href="javascript:;" class="layui-btn  layui-layout-right js_nextToJf" style="width:48%;">确认缴费</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-tab-item">
                <div class="order-content">
                    <i class="sticons icons-hedui" style="height: 35px;"></i>
                    <span style="display: inline-block;margin-left: -10px;margin-top: 10px;">核对订单信息</span>
                </div>
                <div style="margin: 0px 40px;padding: 20px;border: 1px dotted #9090b9;background-color: #DBF8FE;width: 1061px;padding-bottom: 137px;position: relative;height: 450px;">
                    <div class="order-title">
                        <i class="sticons icons-hedui"></i>
                        <span style="margin-top: 5px;display: inline-block;font-weight: bold;margin-left: -10px;">支付信息</span>
                    </div>
                    <div class="order-basicinfo">
                        <span class="basicinfo-name"></span>
                        <span class="basicinfo-tel"></span>
                        <span class="basicinfo-address"></span>
                        <a class="layui-btn js_nextToClass btn-backedit" href="javascript:;" style="">返回修改</a>
                    </div>
                    <div class="payLine"></div>
                    <div class="order-classinfo layui-clear">
                        <div class="order-classname">
                            <i class="sticons icons-ordercuri"></i>
                            <div class="otitle">课程</div>
                            <div class="oinfo js_orderClassName"></div>
                        </div>

                        <div class="order-classname">
                            <i class="sticons icons-orderclass"></i>
                            <div  class="otitle">班级</div>
                            <div class="oinfo js_orderGrade"></div>
                        </div>

                        <div class="order-classname">
                            <i class="sticons icons-needpay"></i>
                            <div class="otitle">合计金额</div>
                            <div class="oinfo js_orderAllNeedPay"></div>
                        </div>

                        <div class="order-classname">
                            <i class="sticons icons-youhui"></i>
                            <div class="otitle">优惠</div>
                            <div class="oinfo js_orderYouhui">0</div>
                        </div>
                    </div>

                    <div class="order-classinfo layui-clear" style="margin: 10px;">
                        <div class="order-classname">
                            <span class="ztitle">预缴</span>
                            <span class="zinfo js_orderPrePay " id="js_orderPrePay">0</span>
                        </div>
                        <div class="order-classname">
                            <span class="ztitle">欠费</span>
                            <span class="zinfo js_orderNeedPay" id="js_orderNeedPay">0</span>
                        </div>
                    </div>
                    <div class="payLine"></div>

                    <div class="order-paytype layui-clear">
                        <div class="paytype active" data-paytype="0">
                            <a>
                                <img src="/static/images/zhifubao.png">
                            </a>
                            <div class="qrcode"><img src="/static/images/zfb.png"></div>
                        </div>
                        <div class="paytype" data-paytype="1">
                            <a>
                                <img src="/static/images/weixin.png">
                            </a>
                            <div class="qrcode"><img src="/static/images/zfb.png"></div>
                        </div>
                        <div class="paytype" data-paytype="2">
                            <a>
                                <img src="/static/images/pos.png">
                            </a>
                        </div>
                        <div class="paytype" data-paytype="3">
                            <a>
                                <img src="/static/images/yinhangka.png">
                            </a>
                        </div>
                        <div class="paytype" data-paytype="4">
                            <a>
                                <img src="/static/images/xianjin.png">
                            </a>
                        </div>
                    </div>
                    <input type="hidden" name="curriculumId" id="curriculumId"/>
                    <input type="hidden" name="classesId" id="classesId"/>
                    <input type="hidden" name="discountAmount" id="discountAmount"/>
                    <input type="hidden" name="payType" id="payType" value="0"/>
                    <input type="hidden" name="studentId" id="studentIdHid"/>
                    <div class="opbox">
                        <div class=" layui-clear" style="margin-top: 50px;">

                            <span class="operateUser">经办人：</span>
                            <input type="text" class="layui-input opInput"  id="operateUserInupt" value="" name="operateUser" required placeholder="">
                        </div>
                        <div class=" layui-clear" style="margin-top: 10px;">

                            <span class="operateDesc" style="margin-right: 29px;">备注：</span>
                            <input type="text" class="layui-input opInput" id="desc" name="opdesc"  placeholder="">
                        </div>
                    </div>
                    <div style="width: 1061px;margin: 0 0 0 82px;position: absolute;right: -1px;top: 606px;">
                        <div class="real-pay" >
                            <span class="realpay--title">付款：</span>
                            <span class="realpay--price-symbol">¥</span>
                            <span class="realpay--price js_orderPrePay" style="color: rgb(255, 0, 54);"></span>
                        </div>
                        <div style="position: absolute; right: 0;top: 73px;">
                            <a href="javascript:;" class="layui-btn go-btn" >确认并支付</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</form>
<script type="text/javascript" src="/static/layui/layui.js"></script>
<script type="text/javascript" src="/static/js/jquery.js"></script>
<script type="text/javascript" src="/static/js/jquery.validate.js"></script>
<script type="text/javascript" src="/static/js/site.js"></script>
<script>
    layui.use(['form', 'layer', 'table', 'element'], function () {
        var form = layui.form,
            layer = parent.layer === undefined ? layui.layer : top.layer,
            $ = layui.jquery,
            element = layui.element,
            table = layui.table;

        form.verify({
            money: function (val, item) {
                if (!/^\d+(\.\d{0,2})?$/.test(val)) {
                    return '请输入正确的格式'
                }
            }
        });

        //默认当前年份
        $("#startYear").val((new Date).getFullYear());

        var classList;
        $.post("/classes/selectListData", function (data) {
            var t = 0;
            classList = data.data;

            classList.forEach(function (e) {
                if (t == 0) {
                    initClassInfo(e);
                }
                t++;
                $("#classesSselectId").append("<option value='" + e.id + "'>" + e.className + "</option>");
            });
            form.render('select');//重新渲染
        });
        form.on('select(classesSselectId)', function (data) {
            classList.forEach(function (e) {
                if (data.value == e.id) {
                    initClassInfo(e);
                    $("#preferential").val("0");
                }
            });

        });

        form.on('select(js_gradeSel)', function (data) {
            var date = new Date;
            var year = date.getFullYear();
            $("#startYear").val(year - data.value + 1);

        });

        function initClassInfo(data) {

            //班型
            $("#gradeType").html(getClassesType(data.classType));
            $(".js_orderClassName").html(data.className);
            $("#classesId").val(data.id);
            $.post("/curriculum/findById?id=" + data.curriculumID, function (curi) {
                $("#grade").html(getGradeType(curi.data.grade));
                $("#curriculumId").val(data.curriculumID);
                //类型
                $("#classType").html(getSeType(curi.data.semester));
                $("#kcfee").html(curi.data.price);
                $(".js_orderAllNeedPay").html(curi.data.price);
                $("#noPay").html(curi.data.price);
                $(".js_orderGrade").html(curi.data.curriculumName);
                //人数
                $("#stuCount").html(curi.data.appliedCount);

            });
        }

        $(".js_preToClass").on("click", function () {
            element.tabChange('enrollForm', 'basicInfo');
            window.scrollTo(0,0);
        });
        $(".js_nextToClass").on("click", function () {
            if (validBasicForm()) {
                element.tabChange('enrollForm', 'classInfo');
                window.scrollTo(0,0);
            } else {
                return false;
            }
        });

        $(".js_nextToJf").on("click", function () {

            $(".js_orderAllNeedPay").html($("#kcfee").html());
            $(".js_orderYouhui").html($("#preferential").val());
            $(".js_orderPrePay").html($("#prePay").val());
            $(".js_orderNeedPay").html($("#noPay").html());

            $(".basicinfo-name").html($("#userName").val());
            $(".basicinfo-address").html($("#homeAddress").val());
            $(".basicinfo-tel").html($("#mobilePhone1").val());
            $("#discountAmount").val($(".js_orderYouhui").html());

            if (validFeeForm()) {
                element.tabChange('enrollForm', 'feeInfo');
                window.scrollTo(0,0);
            } else {
                return false;
            }
        });

        $(".go-btn").on("click", function () {
            var frm = $("#studentForm");

            if (validOrderForm()) {
                layer.confirm('确定已付款,添加报名信息？', {icon: 3, title: '提示信息'}, function (index) {
                    layer.close(index);
                    var indexLoading = top.layer.msg('正在创建订单，请稍候...',{icon: 16,time:false,shade:0.8});
                    $.post("/student/add",frm.serialize(),function(res){
                        if (res.data){
                            $("#studentIdHid").val(res.data);
                            $.post("/order/createById",frm.serialize(),function(res){
                                if (res.data){
                                    layer.close(index);
                                    layer.msg("报名成功！");
                                    //location.reload();
                                    setTimeout('location.reload()',1000);
                                } else {
                                    layer.msg(data.msg);
                                }
                            })
                        } else {
                            layer.msg("创建学生失败");
                        }
                    })

                })
            } else {
                return false;
            }
        });
        $(".paytype").on("click", function () {
            $(this).addClass("active").siblings().removeClass("active");
            $("#payType").val($(this).data("payType"));
        });

        function validOrderForm(){
            var $validator = $("#studentForm").validate();
            if (!$validator.element($("#operateUserInupt"))) {
                return false;
            }
            return true;
        }

        function validFeeForm() {
            var $validator = $("#studentForm").validate();
            if (!$validator.element($("#classCusInfo"))) {
                return false;
            }
            var $validator = $("#studentForm").validate();
            if (!$validator.element($("#preferential"))) {
                return false;
            }
            var $validator = $("#studentForm").validate();
            if (!$validator.element($("#prePay"))) {
                return false;
            }

            return true;
        }
        $('#preferential').on('input propertychange', function(){
            var allMoney = $("#kcfee").text();
            var yhMoney = $(this).val();
            $(".js_orderYouhui").val(yhMoney);
            var preMoney = $("#prePay").val();
            var noPay = allMoney - yhMoney - preMoney;
            if (noPay > 0 ) {
                $("#noPay").text(noPay);
                $(".js_orderNeedPay").html(noPay);
            }else {
                $("#noPay").text(0);
                $(".js_orderNeedPay").html(0);
            }

        });

        $('#prePay').on('input propertychange', function(){
            var allMoney = $("#kcfee").text();
            var preMoney = $(this).val();
            $("js_orderPrePay").val(preMoney);
            var yhMoney = $("#preferential").val();
            var noPay = allMoney - yhMoney - preMoney;
            if (noPay > 0 ) {
                $("#noPay").text(noPay);
                $(".js_orderNeedPay").html(noPay);
            }else {
                $("#noPay").text(0);
                $(".js_orderNeedPay").html(0);
            }
        })

        function validBasicForm() {
            var $validator = $("#studentForm").validate();
            if (!$validator.element($("#userName"))) {
                return false;
            }
            if (!$validator.element($("#mobilePhone1"))) {
                return false;
            }
            if (!$validator.element($("#phone1Info"))) {
                return false;
            }
            if (!$validator.element($("#mobilePhone2"))) {
                return false;
            }
            if (!$validator.element($("#phone2Info"))) {
                return false;
            }
            if (!$validator.element($("#school"))) {
                return false;
            }
            return true;
        }

        $(".js_preToBasic").on("click", function () {
            element.tabChange('enrollForm', 'basicInfo');
        });





    })

    // $.fn.extend($.validator.defaults, {
    //     //重写showErrors
    //     showErrors: function (errorMap, errorList) {
    //         $.each(errorList, function (i, v) {
    //             //在此处用了layer的方法,显示效果更美观
    //             if($(v.element)[0].tagName.indexOf("SELECT")>-1){ // 针对于select2  控件做了调整
    //                 layer.tips(v.message, $(v.element).next(), {icon: 2 , time: 3000 });
    //             }else{
    //                 layer.tips(v.message, v.element, {icon: 2 , time: 3000 });
    //             }
    //             return false;
    //         });
    //     }
    // });

</script>
</body>
</html>